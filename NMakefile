# libcouchbase
# Copyright (C) 2011 Couchbase, Inc
# All rights reserved.
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
#
# Description: Build libcouchbase as a dll on Microsoft Windows
# Author     : Trond Norbye <trond.norbye@gmail.com>

TARGETOS=WINNT
!include <win32.mak>

INSTALL=c:\local
INSTALLDIRS=$(INSTALL) $(INSTALL)\include $(INSTALL)\include\libcouchbase $(INSTALL)\lib $(INSTALL)\bin

DBGFLG=-Zi


INCPATH=-I$(INSTALL)\include -Iwin32 -Isrc -Iinclude
COMPILE=$(cc) $(cdebug) $(cflags) $(DBGFLG) $(INCPATH)
DLLCOMPILE=$(cc) $(cdebug) $(cflags) $(cvarsdll) $(DBGFLG) $(INCPATH) -DLIBCOUCHBASE_INTERNAL=1

LIBCOUCHBASE_OBJS=arithmetic.obj \
     base64.obj \
     cookie.obj \
     error.obj \
     event.obj \
     get.obj \
     gethrtime.obj \
     handler.obj \
     instance.obj \
     iofactory_win32.obj \
     packet.obj \
     plugin-win32.obj \
     remove.obj \
     server.obj \
     store.obj \
     strerror.obj \
     tap.obj \
     timings.obj \
     touch.obj \
     utilities.obj \
     wait.obj

example\memcat.exe: example\memcat.obj win32\getopt.obj libcouchbase.dll
	$(link) -out:example\memcat.exe example\memcat.obj \
                win32\getopt.obj libcouchbase.lib

example\memcat.obj: example\memcat.c
	$(COMPILE) -Foexample\memcat.obj example\memcat.c

win32\getopt.obj: win32\getopt.c win32\getopt.h
	$(COMPILE) -Fowin32\getopt.obj win32\getopt.c

libcouchbase.dll: $(LIBCOUCHBASE_OBJS)
	$(link) $(dlllflags)  /LIBPATH:$(INSTALL)\lib libvbucket.lib \
                libsasl.lib ws2_32.lib \
                -out:libcouchbase.dll -version:1.0 $(LIBCOUCHBASE_OBJS)

arithmetic.obj: src\arithmetic.c
	$(DLLCOMPILE) src\arithmetic.c

base64.obj: src\base64.c
	$(DLLCOMPILE) src\base64.c

cookie.obj: src\cookie.c
	$(DLLCOMPILE) src\cookie.c

event.obj: src\event.c
	$(DLLCOMPILE) src\event.c

error.obj: src\error.c
	$(DLLCOMPILE) src\error.c

wait.obj: src\wait.c
	$(DLLCOMPILE) src\wait.c

get.obj: src\get.c
	$(DLLCOMPILE) src\get.c

gethrtime.obj: src\gethrtime.c
	$(DLLCOMPILE) src\gethrtime.c

handler.obj: src\handler.c
	$(DLLCOMPILE) src\handler.c

instance.obj: src\instance.c
	$(DLLCOMPILE) src\instance.c

iofactory_win32.obj: src\iofactory_win32.c
	$(DLLCOMPILE) src\iofactory_win32.c

packet_debug.obj: src\packet_debug.c
	$(DLLCOMPILE) src\packet_debug.c

packet.obj: src\packet.c
	$(DLLCOMPILE) src\packet.c

plugin-win32.obj: src\plugin-win32.c
	$(DLLCOMPILE) src\plugin-win32.c

remove.obj: src\remove.c
	$(DLLCOMPILE) src\remove.c

server.obj: src\server.c
	$(DLLCOMPILE) src\server.c

store.obj: src\store.c
	$(DLLCOMPILE) src\store.c

strerror.obj: src\strerror.c
	$(DLLCOMPILE) src\strerror.c

tap.obj: src\tap.c
	$(DLLCOMPILE) src\tap.c

timings.obj: src\timings.c
	$(DLLCOMPILE) src\timings.c

touch.obj: src\touch.c
	$(DLLCOMPILE) src\touch.c

utilities.obj: src\utilities.c
	$(DLLCOMPILE) src\utilities.c


install: $(INSTALLDIRS) libcouchbase.dll
	@copy include\libcouchbase\*.h $(INSTALL)\include\libcouchbase
	@copy libcouchbase.dll $(INSTALL)\lib
	@copy libcouchbase.dll $(INSTALL)\bin
	@copy libcouchbase.exp $(INSTALL)\lib
	@copy libcouchbase.lib $(INSTALL)\lib

clean:
	-@del $(LIBCOUCHBASE_OBJS) libcouchbase.dll libcouchbase.exp libcouchbase.lib vc100.pdb example\memcat.obj example\memcat.exe win32\getopt.obj
